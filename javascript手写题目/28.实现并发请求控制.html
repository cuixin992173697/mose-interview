<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      // 实现并发请求控制

      /**
       * urls长度为0时，results没有值，返回空数组
       * maxNum 大于urls长度时，相当于全部并发请求，应该去urls长度，否则取maxNum
       * 需要定义一个count计数器来判断请求是否全部完成
       * 所有请求成功或报错的结果保存在results数组中
       * results数组的索引和urls数组的索引一一对应
       */

      function concurrentRequest(urls, maxNum) {
        return new Promise(resolve => {
          if (urls.length === 0) {
            resolve([]);
            return;
          }

          const results = [];
          let index = 0; // 下一个请求的索引
          let count = 0; // 已完成请求的数量

          async function request() {
            if (index >= urls.length) {
              return;
            }
            const i = index; //保存索引，使当前索引和result相对应
            const url = urls[index];

            index++;

            try {
              const resp = await fetch(url);
              results[i] = resp;
            } catch (error) {
              results[i] = error;
            } finally {
              count++;
              if (count === urls.length) {
                resolve(results);
              }
              request(); // 发起下一个请求
            }
          }

          const times = Math.min(maxNum, urls.length);
          for (let i = 0; i < times; i++) {
            request();
          }
        });
      }

      const urls = [];
      for (let i = 1; i <= 20; i++) {
        urls.push(`https://jsonplaceholder.typicode.com/todos/${i}`);
      }
      concurrentRequest(urls, 3).then(res => {
        console.log(res);
      });
    </script>
  </body>
</html>
